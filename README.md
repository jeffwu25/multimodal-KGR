# multimodal-KGR

Code for implementing multimodal spatiotemporal modeling with kernel graph regression (KGR) and copula models

Authors: Jeffrey Wu, Gareth W Peters (UCSB)

In this project, we develop a novel, low complexity framework for modeling spatiotemporal multimodal data. The utility of this framework is demonstrated with a case study involving jointly modeling the daily excess number of deaths due to heat and the corresponding average maximum air temperature across the nine regions of England during the summer months (June-Sept) of 2018. The overarching research question for this project is: does the inclusion of a copula function to model the dependence between modalities lead to improved forecasts compared to marginal forecasts made with KGR models? This paper focuses on a two
modality problem, but the proposed framework can easily be extended to more modalities.

## Data folder

This folder contains all the datasets and geographic files needed to run the analysis in the other folders. The first modality, excess deaths, is obtained from an Office of National Statistics (ONS) report (https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/articles/excessmortalityduringheatperiods/englandandwales1juneto31august2022#excess-mortality-during-heat-periods-data). This dataset contains excess deaths for all the different regions of the UK for each day of the summer months from 2016-2022. For the case study, this data is subsetted to the regions of England in 2018. The second modality, daily maximum temperature, is obtained from the Centre for Environmental Data Analysis (CEDA) archive. The Meteorological (Met) Office provides weather data from Met Office Integrated Data Archive System (MIDAS) stations at (https://catalogue.ceda.ac.uk/uuid/dbd451271eb04662beade68da43546e1/). These stations are scattered all over, and so three stations were identified for each county within a given region to gather about ten stations for each of the nine regions of England. 
 
## Multimodal-KGR-data.qmd

Downloads and processes the two datasets mentioned above.

## Multimodal-KGR-marginals.qmd

Fits KGR models to each of the modalities separately. This involves learning a spatial dependence structure with an estimated graph produced by the package "huge" and a temporal dependence structure with a locally periodic radial basis function (RBF) kernel. To facilitate the estimation of these high dimensional models, the Integrated Nested Laplace Approximation (INLA) is used for approximate Bayesian inference. A rolling one step ahead forecasting exercise is implemented at the end to predict the last seven days' values for all regions and both modalities one day at a time. These forecasts serve as the baseline to be compared with the forecasts made by including a copula function to model the joint distribution of the latent processes of the two modalities. 

## inla-grid-search.r

Implements the grid search for each KGR model's temporal kernel hyperparameters. A Latin hypercube sampling scheme is used to generate a grid of potential hyperparameters values for a scale and two length parameters. Different sets of hyperparameter values are plugged in to calculate the temporal kernel and then fed into the KGR model. A KGR model is fit for each set of values and then the WAIC is extracted, so this step is a bit computationally expensive; hence, it was coded as an R script to be run as a background job on a container environment. 

## Multimodal-KGR-copula.qmd 

Fits the proposed copula modeling approach to the multimodal data. This involves taking the marginal forecasts made in "Multimodal-KGR-marginals.qmd" and using them to estimate a multivariate t copula. Specifically, the copula is estimated with an algorithm akin to Inference Functions for Margins (IFM), see the paper for details. Once the copula is estimated, forecasts are generated by sampling from the copula and transforming those samples back into predictions of each modality's latent process, see the paper for details. Plots and error metrics are generated. The inclusion of a copula is shown to improve forecast accuracy for all regions and all out of sample days, specifically for the excess deaths modality, which is severely overestimated by the marginal KGR model. 
